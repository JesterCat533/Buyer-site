<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Creation Order</title>
    <!-- Using Poppins from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --black: #000000;
            --red: #FF0000;
            --dark-red: #8B0000;
            --light-grey: #AAAAAA;
            --white: #FFFFFF;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--black);
            color: var(--light-grey);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Parallax & Dotted Background --- */
        #parallax-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .dot {
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: background-color 0.5s ease, box-shadow 0.5s ease, transform 0.1s ease;
        }

        .dot.lit {
            background-color: var(--red);
            box-shadow: 0 0 5px var(--red), 0 0 10px var(--dark-red);
            transform: scale(2);
        }

        /* --- Main Content Styling --- */
        .content-wrapper {
            background-color: rgba(10, 10, 10, 0.95);
            padding: 40px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.3);
            z-index: 10;
            border: 2px solid var(--dark-red);
            overflow-y: auto;
            max-height: 95vh;
        }

        .red-text {
            color: var(--red);
        }

        h1, h2 {
            color: var(--white);
            border-bottom: 1px solid rgba(255, 0, 0, 0.2);
            padding-bottom: 5px;
            margin-top: 20px;
            font-weight: 600;
        }

        /* --- Form and Options --- */
        .input-group, .summary-box {
            margin-bottom: 20px;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: var(--white);
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--red);
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .option-card {
            flex-grow: 1;
            display: block;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            background-color: #0d0d0d;
            transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
            text-align: center;
            min-width: 120px;
        }

        .option-card:hover {
            border-color: var(--light-grey);
        }

        .option-card input {
            display: none; /* Hide native radio/checkbox */
        }

        /* Style the card with a glowing outline when the hidden input is checked */
        .option-card:has(input:checked) { 
            border-color: var(--red); /* Change the physical border color */
            background-color: #0d0d0d; /* Ensure background stays dark */
            box-shadow: 0 0 12px var(--red); /* Apply external glow */
        }
        
        .card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; /* Allows click on the label to trigger input */
        }


        /* --- Summary and Button --- */
        .summary-box {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--dark-red);
            text-align: center;
        }

        .total-price {
            font-size: 2.2em;
            font-weight: 700;
            margin: 5px 0 15px;
            color: var(--white);
        }

        #checkout-button {
            width: 100%;
            padding: 15px;
            background-color: var(--red);
            color: var(--white);
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, opacity 0.3s;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }

        #checkout-button:hover:not(:disabled) {
            background-color: #FF4500;
            transform: translateY(-2px);
        }
        
        #checkout-button:disabled {
            background-color: #333;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        .payment-note {
            font-size: 0.8em;
            margin-top: 10px;
            color: var(--light-grey);
        }

        .hidden {
            display: none !important;
        }
        
        /* --- Modal Styling --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            border: 2px solid var(--red);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
            text-align: center;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            color: var(--red);
            margin-top: 0;
            border-bottom: 1px solid rgba(255, 0, 0, 0.3);
            padding-bottom: 10px;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: var(--light-grey);
        }

        .modal-close-btn {
            background: var(--red);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .modal-close-btn:hover {
            background: #FF4500;
        }

        /* Responsive adjustments */
        @media (max-width: 500px) {
            .content-wrapper {
                padding: 20px;
                margin: 20px 0;
            }
            .option-group {
                flex-direction: column;
            }
            .option-card {
                width: 100%;
            }
            .total-price {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div id="parallax-container">
        <!-- Dots generated by JS -->
    </div>
    <main class="content-wrapper">
        <header>
            <h1><span class="red-text">Custom</span> Order Portal</h1>
            <p>Define your creation and get an instant price quote.</p>
        </header>
        <section class="order-form-container">
            <form id="order-form">
                <div class="input-group">
                    <label for="discord-username">Your Discord Username <span class="red-text">*</span></label>
                    <input type="text" id="discord-username" name="discordUsername" placeholder="e.g., username#1234 or @username" required>
                </div>
                
                <h2>1. Select Type</h2>
                <div class="option-group" id="type-options">
                    <label class="option-card">
                        <input type="radio" name="itemType" value="Video" required checked>
                        <div class="card-content">Video - starting at $10</div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="itemType" value="Image" required>
                        <div class="card-content">Image - starting at $1</div>
                    </label>
                </div>

                <div id="dynamic-options-container">
                    <!-- Video Type Options -->
                    <div id="video-options" class="style-options option-group">
                        <h2>2. Video Style</h2>
                        <label class="option-card">
                            <input type="radio" name="videoType" value="thigh vid" checked>
                            <div class="card-content">Thigh Vid ($10)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="videoType" value="jerky vid">
                            <div class="card-content">Jerky Vid ($12)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="videoType" value="creamy vid">
                            <div class="card-content">Creamy Vid ($15)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="videoType" value="squish vid">
                            <div class="card-content">Squish Vid ($18)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="videoType" value="finger vid">
                            <div class="card-content">Finger Vid ($20)</div>
                        </label>
                    </div>

                    <!-- Image Options -->
                    <div id="image-options" class="size-options option-group hidden">
                        <h2>2. Size/Resolution</h2>
                        <label class="option-card">
                            <input type="radio" name="imageSize" value="Small" checked>
                            <div class="card-content">Small ($1)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="imageSize" value="Medium">
                            <div class="card-content">Medium ($3)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="imageSize" value="Large">
                            <div class="card-content">Large ($5)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="imageSize" value="XL">
                            <div class="card-content">XL ($7)</div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="imageSize" value="Super-Size">
                            <div class="card-content">Super-Size ($8)</div>
                        </label>
                    </div>
                </div>

                <h2>3. Features</h2>
                <div class="option-group">
                    <label class="option-card feature-option">
                        <input type="checkbox" name="feature" value="Clothed">
                        <div class="card-content">Clothed (-$1 Discount)</div>
                    </label>
                    <label class="option-card feature-option">
                        <input type="checkbox" name="feature" value="Other">
                        <div class="card-content">Other (No Cost Change)</div>
                    </label>
                </div>

                <h2>4. Additional Context</h2>
                <div class="input-group">
                    <textarea id="additional-context" name="context" rows="4" placeholder="Add any extra details or requirements for your order..."></textarea>
                </div>

                <div class="summary-box">
                    <p class="total-price">
                        <span class="red-text">TOTAL:</span> <span id="final-price">$10.00</span>
                    </p>
                    <button type="submit" id="checkout-button">
                        <span id="button-text">Proceed to Payment</span>
                    </button>
                    <p class="payment-note">Secure payment will be processed via Stripe. Your order details will be sent to the seller via Discord webhook upon successful purchase.</p>
                </div>
            </form>
        </section>
    </main>

    <!-- Custom Modal/Message Box -->
    <div id="message-modal" class="modal-overlay hidden" onclick="closeMessage(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button class="modal-close-btn" onclick="closeMessage()">Close</button>
        </div>
    </div>

    <script>
        // CLIENT-SIDE PRICE MAP (Used only for display, server-side calculates the final charged amount for security)
        const PRICE_MAP_DISPLAY = {
            'thigh vid': 10, 'jerky vid': 12, 'creamy vid': 15, 'squish vid': 18, 'finger vid': 20,
            'Small': 1, 'Medium': 3, 'Large': 5, 'XL': 7, 'Super-Size': 8,
            'Clothed': -1, 'Other': 0
        };

        // Helper to show the custom modal message
        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            requestAnimationFrame(() => {
                document.getElementById('message-modal').classList.add('visible');
            });
        }

        // Helper to close the custom modal message
        function closeMessage(event) {
            const modal = document.getElementById('message-modal');
            if (!event || event.target.id === 'message-modal' || event.target.classList.contains('modal-close-btn')) {
                modal.classList.remove('visible');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300); 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('order-form');
            const finalPriceDisplay = document.getElementById('final-price');
            const videoOptionsDiv = document.getElementById('video-options');
            const imageOptionsDiv = document.getElementById('image-options');
            const checkoutButton = document.getElementById('checkout-button');
            const buttonText = document.getElementById('button-text');
            const allOptions = form.querySelectorAll('.option-card input[type="radio"], .option-card input[type="checkbox"]');

            // --- Pricing Logic (Client-side display only) ---
            function calculateTotal() {
                let total = 0;
                const selectedTypeInput = form.querySelector('input[name="itemType"]:checked');
                if (!selectedTypeInput) return; 
                const selectedType = selectedTypeInput.value;

                let mainOptionInput;
                if (selectedType === 'Video') {
                    mainOptionInput = form.querySelector('input[name="videoType"]:checked');
                } else if (selectedType === 'Image') {
                    mainOptionInput = form.querySelector('input[name="imageSize"]:checked');
                }

                if (mainOptionInput) {
                    total += PRICE_MAP_DISPLAY[mainOptionInput.value] || 0;
                }

                const features = form.querySelectorAll('input[name="feature"]:checked');
                features.forEach(feature => {
                    total += PRICE_MAP_DISPLAY[feature.value] || 0;
                });

                // Ensure price is minimum $1.00 (100 cents) for display
                total = Math.max(1, total); 
                finalPriceDisplay.textContent = `$${total.toFixed(2)}`;
            }

            // Function to toggle style/size options based on Type
            function toggleOptions() {
                const selectedType = form.querySelector('input[name="itemType"]:checked').value;
                
                if (selectedType === 'Video') {
                    videoOptionsDiv.classList.remove('hidden');
                    imageOptionsDiv.classList.add('hidden');
                    if (!form.querySelector('input[name="videoType"]:checked')) {
                        // Ensure a default is selected when switching
                        form.querySelector('input[name="videoType"][value="thigh vid"]').checked = true;
                    }
                } else if (selectedType === 'Image') {
                    videoOptionsDiv.classList.add('hidden');
                    imageOptionsDiv.classList.remove('hidden');
                    if (!form.querySelector('input[name="imageSize"]:checked')) {
                        // Ensure a default is selected when switching
                        form.querySelector('input[name="imageSize"][value="Small"]').checked = true;
                    }
                }
                calculateTotal();
            }

            // Attach listeners for dynamic pricing
            form.querySelectorAll('input[name="itemType"]').forEach(input => {
                input.addEventListener('change', toggleOptions);
            });
            allOptions.forEach(input => {
                input.addEventListener('change', calculateTotal);
            });
            
            toggleOptions();


            // --- Parallax Dotted Background Logic ---
            const DOT_COUNT = 80;
            const DISTANCE_THRESHOLD = 150; 
            const parallaxContainer = document.getElementById('parallax-container');
            const dots = [];

            function generateDots(container, count) {
                for (let i = 0; i < count; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    dot.style.left = `${Math.random() * 100}vw`;
                    dot.style.top = `${Math.random() * 100}vh`;
                    dot.dataset.speed = (Math.random() * 1 + 0.5).toFixed(2);
                    container.appendChild(dot);
                    dots.push(dot);
                }
            }
            generateDots(parallaxContainer, DOT_COUNT);

            let mouseX = window.innerWidth / 2;
            let mouseY = window.innerHeight / 2;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            function animateParallax() {
                dots.forEach(dot => {
                    const rect = dot.getBoundingClientRect();
                    const dotX = rect.left + rect.width / 2;
                    const dotY = rect.top + rect.height / 2;

                    const distance = Math.hypot(dotX - mouseX, dotY - mouseY);

                    if (distance < DISTANCE_THRESHOLD) {
                        dot.classList.add('lit');
                    } else {
                        dot.classList.remove('lit');
                    }
                    
                    const speed = parseFloat(dot.dataset.speed);
                    const xShift = (mouseX - window.innerWidth / 2) / 50 * speed;
                    const yShift = (mouseY - window.innerHeight / 2) / 50 * speed;
                    dot.style.transform = `translate(${xShift}px, ${yShift}px) scale(${dot.classList.contains('lit') ? 1.5 : 1})`;
                });
                requestAnimationFrame(animateParallax);
            }

            animateParallax();


            // --- Form Submission: Fetch Stripe Session ---

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const data = {};
                
                // Collect form data into a structured object for the server
                formData.forEach((value, key) => {
                    // Handle multiple checkboxes with the same name ('feature')
                    if (key === 'feature') {
                        if (data[key]) {
                            // If it's already an array, push the new value
                            data[key].push(value);
                        } else {
                            // Initialize as array
                            data[key] = [value];
                        }
                    } else {
                        data[key] = value;
                    }
                });
                
                if (!data.discordUsername || data.discordUsername.trim() === '') {
                    showMessage('Missing Information', 'Please provide your Discord Username to proceed.');
                    return;
                }

                buttonText.textContent = 'Processing...';
                checkoutButton.disabled = true;

                try {
                    // Send order data to the Node.js backend endpoint
                    const response = await fetch('/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                    
                    const session = await response.json();

                    if (session.url) {
                         // Redirect to Stripe's hosted payment page
                         window.location.href = session.url;
                    } else if (session.error) {
                         throw new Error(session.error);
                    } else {
                         throw new Error("Failed to receive a valid checkout URL from the server.");
                    }

                } catch (error) {
                    console.error('Checkout error:', error);
                    showMessage(
                        'Checkout Error', 
                        `There was an issue: ${error.message}. Please try again.`
                    );
                } finally {
                    buttonText.textContent = 'Proceed to Payment';
                    checkoutButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
