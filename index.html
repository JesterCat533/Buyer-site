<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> üñ§ Jester x Envy Shop üñ§</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Changed font to Rye for a sharp, edgy aesthetic */
        @import url('https://fonts.googleapis.com/css?family=Rye&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');


        body {
            font-family: 'Roboto Mono', monospace; /* Used for readability */
            background-color: #000000;
            min-height: 100vh;
            overflow-x: hidden;
            color: #f7f7f7;
            position: relative;
        }

        /* Canvas for background - Kept the concept but changed the aesthetic */
        #dotCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6; /* Slight transparency for a darker feel */
        }

        /* Container for content */
        .content-container {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* Custom scrollbar for an edgy look */
        ::-webkit-scrollbar {
            width: 12px;
            background-color: #0d0d0d;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            background-color: #CC0000;
            /* Dark Red */
            border: 3px solid #0d0d0d;
        }

        ::-webkit-scrollbar-track {
            border-radius: 10px;
            background-color: #0d0d0d;
        }

        /* Item card style */
        .item-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #111111;
            /* Very dark gray */
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 0, 0, 0.4);
            /* Red glow */
        }

        /* Custom checkout button style */
        .checkout-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.6);
            /* Red shadow */
            background: linear-gradient(145deg, #FF0000, #CC0000);
            /* Red gradient */
            color: #111111; /* Dark text for contrast */
        }

        .checkout-button:hover {
            background: linear-gradient(145deg, #CC0000, #FF0000);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.8);
            transform: translateY(-2px);
        }

        /* Custom red border for selected item */
        .item-selected {
            border-color: #FF0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
            background-color: #1a0000; /* Dark red background for selected */
        }

        /* Modal styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #111111;
            /* Dark background */
            border: 3px solid #FF0000;
            /* Red border */
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.8);
            /* Strong red glow */
        }
    </style>
</head>

<body class="selection:bg-red-700 selection:text-white">

    <canvas id="dotCanvas"></canvas>

    <div class="content-container">

        <header class="py-6 border-b-2 border-red-500/30 mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold font-['Rye'] text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-red-900 text-center uppercase tracking-widest">
                üñ§ Dark & Edgy Customs Shop ü©∏
            </h1>
            <p id="userIdDisplay" class="text-xs text-red-300/70 text-center mt-2 font-mono">
                System Initializing...
            </p>
        </header>

        <div id="messageBox" class="fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-500 opacity-0 hidden"
            role="alert">
            <div id="messageText" class="font-bold"></div>
        </div>

        <section class="mb-12">
            <h2 class="text-3xl font-bold text-red-500 mb-6 text-center font-['Rye'] uppercase tracking-wider">
                Unleash Your Desire
            </h2>
            <div id="itemContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                </div>
        </section>

        <section class="sticky bottom-0 bg-black/90 backdrop-blur-sm py-4 border-t-2 border-red-500/30 rounded-t-xl">
            <div class="flex flex-col md:flex-row justify-between items-center px-4">
                <div class="flex-grow mb-4 md:mb-0">
                    <h3 class="text-2xl font-bold text-red-500">Your Cart (<span id="cartCount">0</span> Items)</h3>
                    <div id="cartDisplay" class="text-sm text-gray-300 min-h-[20px] max-h-[100px] overflow-y-auto pr-2">
                        <p class="italic text-gray-700">Cart is empty.</p>
                    </div>
                </div>

                <div class="flex flex-col items-center space-y-2 md:space-y-0 md:space-x-4 md:flex-row">
                    <p class="text-xl font-bold text-white">Total: <span id="cartTotal" class="text-red-500">$0.00</span></p>
                    <button id="checkoutButton" onclick="handleCheckout()"
                        class="checkout-button text-black font-extrabold py-3 px-8 rounded-full text-lg uppercase tracking-wider hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        Execute Transaction
                    </button>
                </div>
            </div>
        </section>

    </div>

    <div id="paymentModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content w-11/12 md:w-1/3 p-6 md:p-8 rounded-2xl text-center">
            <h3 class="text-3xl font-extrabold text-red-500 mb-4 font-['Rye']">EXECUTE MANUAL PAYMENT!</h3>
            <p class="text-lg text-gray-200 mb-6">
                Transfer the exact amount below to
                <a href="https://paypal.me/CookieCutie167" target="_blank" class="text-red-400 hover:text-red-300 underline">
                    https://paypal.me/CookieCutie167
                </a>
                to confirm your acquisition.
            </p>

            <div class="bg-gray-900 p-4 rounded-xl mb-6 border border-red-700">
                <p class="text-2xl font-bold text-red-400">Total Amount: <span id="paymentAmount">$0.00</span></p>
            </div>

            <a id="paymentLink" target="_blank"
                class="block w-full text-black font-extrabold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out mb-4"
                style="background: linear-gradient(145deg, #FF0000, #CC0000);">
                Initiate PayPal Transfer
            </a>

            <button onclick="handlePaymentConfirmation()"
                class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out">
                Payment Sent! (Verify)
            </button>
            <p class="text-sm text-gray-500 mt-3">
                <span class="font-bold text-red-600">WARNING:</span> This transaction will self-destruct if not confirmed in 10 minutes.
            </p>
        </div>
    </div>

    <div id="successModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content w-11/12 md:w-1/3 p-6 md:p-8 rounded-2xl text-center">
            <h3 class="text-3xl font-extrabold text-red-500 mb-4 font-['Rye']">TRANSACTION CONFIRMED!</h3>
            <p class="text-lg text-gray-200 mb-6">
                Submit your Discord tag below to initiate content delivery.
            </p>

            <input type="text" id="discordUsernameInput" placeholder="YourDiscordTag#0000"
                class="w-full p-3 mb-4 rounded-lg bg-gray-900 text-white border border-red-700 focus:border-red-500 focus:ring-1 focus:ring-red-500"
                required>

            <button onclick="submitDiscordUsername()"
                class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out">
                Submit & Await Contact
            </button>
        </div>
    </div>

    <div id="videoOptionsModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content w-11/12 md:w-1/3 p-6 md:p-8 rounded-2xl text-center">
            <h3 class="text-3xl font-extrabold text-red-500 mb-4 font-['Rye']">CUSTOM VIDEO OPTIONS</h3>
            <p class="text-lg text-gray-200 mb-4" id="videoModalTitle"></p>

            <div class="mb-6">
                <label for="videoDuration" class="block text-left text-gray-300 mb-2">Duration (Seconds, minimum 10):</label>
                <input type="number" id="videoDuration" min="10" step="10" value="10"
                    class="w-full p-3 rounded-lg bg-gray-900 text-white border border-red-700 focus:border-red-500 focus:ring-1 focus:ring-red-500 text-center"
                    oninput="updateVideoModalTotal()">
            </div>
            
            <div class="bg-gray-900 p-4 rounded-xl mb-6 border border-red-700">
                <p class="text-xl font-bold text-red-400">Total Price: <span id="videoModalTotal">$0.00</span></p>
            </div>

            <button onclick="addVideoToCart()"
                class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out">
                Add to Cart
            </button>
            <button onclick="document.getElementById('videoOptionsModal').classList.add('hidden')"
                class="w-full mt-3 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out">
                Cancel
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.purchaseRef = null; // Stores the document reference for the current pending purchase

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Constants for the new checkout system
        window.PAYPAL_MAIL = "CookieCutie167";
        window.PAYPAL_ME_URL = `https://paypal.me/${window.PAYPAL_MAIL}/`;
        window.DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1437087889233154130/cMLy9vdMED5dPTEJizjWXvLhz9o7gUZ5ZvxNqDQqcqXntFNnt20fbvCRuhNR6C9X-O4t";
        window.PURCHASE_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

        // Utility to display messages
        window.showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.innerText = message;
            
            // Set colors based on type
            let bgColor = 'bg-gray-700';
            if (type === 'success') bgColor = 'bg-red-700';
            else if (type === 'error') bgColor = 'bg-red-900';
            else if (type === 'warning') bgColor = 'bg-yellow-700';
            
            messageBox.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-500 ${bgColor}`;
            messageBox.classList.remove('opacity-0', 'hidden');

            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 500);
            }, 5000);
        };

        // Firebase Setup and Authentication (Guest Login)
        window.setupFirebase = async function () {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug');

                // Sign in logic
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('userIdDisplay').innerText = `Guest ID: ${window.userId}`;
                        // Check if the user has a pending purchase from a previous session
                        checkPendingPurchase();
                    } else {
                        console.error("Authentication failed. Cannot get user ID.");
                    }
                });

            } catch (error) {
                console.error("Firebase setup failed:", error);
                showMessage("Could not connect to the database. Checkout disabled.", "error");
                document.getElementById('checkoutButton').disabled = true;
            }
        }

        // --- DISCORD WEBHOOK LOGIC ---
        window.sendDiscordNotification = async function (purchaseData, docId, isConfirmation = false) {
            const statusText = isConfirmation ? "PURCHASE FULFILLED" : "NEW PENDING ORDER";
            const color = isConfirmation ? 13369344 : 16724736; // Dark Red/Black for pending, Brighter Red for confirmed
            const details = purchaseData.cart.map(item => {
                let detail = `- **${item.quantity}x** ${item.name} (${item.type})`;
                if (item.duration) {
                    detail += ` [${item.duration}s]`;
                }
                return detail;
            }).join('\n');

            const embed = {
                title: `[${statusText}] - Order #${docId.substring(0, 8)}`,
                color: color,
                description: isConfirmation 
                    ? `Order confirmed for **$${purchaseData.totalAmount.toFixed(2)}**.\n\n**Discord User:** ${purchaseData.discordUsername}`
                    : `Order initiated for **$${purchaseData.totalAmount.toFixed(2)}**.\n\n**Awaiting payment confirmation...**`,
                fields: [
                    { name: "‚õìÔ∏è Cart Items", value: details, inline: false },
                    { name: "üíµ Total Cost", value: `$${purchaseData.totalAmount.toFixed(2)}`, inline: true },
                    { name: "üë§ Guest ID", value: purchaseData.userId, inline: true },
                    { name: "‚è≥ Expires", value: new Date(purchaseData.cleanupTimer).toLocaleString(), inline: false }
                ],
                timestamp: new Date().toISOString(),
                footer: { text: "Dark & Edgy Customs System" }
            };

            try {
                await fetch(window.DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ embeds: [embed] })
                });
                console.log("Discord notification sent successfully.");
            } catch (error) {
                console.error("Failed to send Discord notification:", error);
            }
        };

        // --- PENDING PURCHASE MANAGEMENT ---

        // Check if the current user has a pending purchase on page load/auth complete
        window.checkPendingPurchase = async function () {
            if (!window.userId) return;

            const purchasesColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/pending_purchases`);
            const q = query(purchasesColRef, where("status", "==", "pending"));

            try {
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No pending purchases found for this user.");
                    return;
                }

                // Assuming only one pending purchase per user
                const pendingDoc = querySnapshot.docs[0];
                window.purchaseRef = doc(window.db, pendingDoc.ref.path);
                const pendingData = pendingDoc.data();

                // Check for client-side expiration
                if (pendingData.cleanupTimer < Date.now()) {
                    await checkAndCleanupPurchase(pendingDoc.id);
                    return;
                }

                // User returned with a pending payment. Show payment modal again.
                document.getElementById('paymentAmount').innerText = `$${pendingData.totalAmount.toFixed(2)}`;
                document.getElementById('paymentLink').href = `${window.PAYPAL_ME_URL}${pendingData.totalAmount.toFixed(2)}`;
                document.getElementById('paymentModal').classList.remove('hidden');
                showMessage(`RESUME: Pending acquisition of $${pendingData.totalAmount.toFixed(2)}. Complete transfer now.`, "warning");
                
                // Re-start the cleanup timer
                setTimeout(() => checkAndCleanupPurchase(pendingDoc.id), pendingData.cleanupTimer - Date.now());

            } catch (error) {
                console.error("Error checking pending purchase:", error);
            }
        }

        // Delete purchase if time runs out
        window.checkAndCleanupPurchase = async function (docId) {
            if (!window.db || !window.userId) return;

            const purchaseDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/pending_purchases/${docId}`);

            try {
                const docSnap = await getDoc(purchaseDocRef);
                if (docSnap.exists() && docSnap.data().status === 'pending') {
                    await deleteDoc(purchaseDocRef);
                    console.log(`Pending purchase ${docId} cleaned up due to 10-minute timeout.`);
                    showMessage("Transaction self-destructed due to timeout.", "error");
                    if (window.purchaseRef && window.purchaseRef.id === docId) {
                        window.purchaseRef = null;
                        document.getElementById('paymentModal').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error("Error during cleanup:", error);
            }
        }

        // --- NEW CHECKOUT HANDLERS ---

        window.handleCheckout = async function () {
            if (!window.userId || !window.db) {
                showMessage("System initializing... Stand by.", "error");
                return;
            }

            const total = calculateTotal();
            if (total === 0) {
                showMessage("Cart is empty! Select an item first.", "warning");
                return;
            }

            const cartDetails = window.cart.map(item => ({
                name: item.name,
                type: item.type,
                price: item.price,
                quantity: item.quantity,
                duration: item.duration || 0, // Include duration for video items
                unitPrice: item.unitPrice || item.price // Store base price for videos
            }));

            const purchaseData = {
                userId: window.userId,
                totalAmount: total,
                cart: cartDetails,
                timestamp: serverTimestamp(),
                status: 'pending',
                cleanupTimer: Date.now() + window.PURCHASE_TIMEOUT_MS,
                discordUsername: null
            };

            document.getElementById('checkoutButton').disabled = true;

            try {
                // 1. Save pending purchase to Firestore (Private collection)
                const purchasesColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/pending_purchases`);
                window.purchaseRef = await addDoc(purchasesColRef, purchaseData);

                // 2. Send Initial Discord Webhook
                await sendDiscordNotification(purchaseData, window.purchaseRef.id, false);

                // 3. Show Payment Modal
                document.getElementById('paymentAmount').innerText = `$${total.toFixed(2)}`;
                document.getElementById('paymentLink').href = `${window.PAYPAL_ME_URL}${total.toFixed(2)}`;
                document.getElementById('paymentModal').classList.remove('hidden');

                // 4. Start 10-minute cleanup check
                setTimeout(() => checkAndCleanupPurchase(window.purchaseRef.id), window.PURCHASE_TIMEOUT_MS);
                
                showMessage("Transaction initiated! Complete the transfer now.", "info");

            } catch (error) {
                console.error("Checkout failed:", error);
                showMessage("Checkout process failed due to a system error. Retry.", "error");
                if (window.purchaseRef) {
                    await deleteDoc(window.purchaseRef);
                    window.purchaseRef = null;
                }
            } finally {
                document.getElementById('checkoutButton').disabled = false;
            }
        }

        window.handlePaymentConfirmation = function () {
            if (!window.purchaseRef) {
                showMessage("Error: No pending transaction found.", "error");
                return;
            }
            // Hide payment modal, show success/discord confirmation modal
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('hidden');
        }

        window.submitDiscordUsername = async function () {
            const discordUsername = document.getElementById('discordUsernameInput').value.trim();
            if (!discordUsername) {
                showMessage("Discord tag required to deliver content.", "warning");
                return;
            }

            if (!window.purchaseRef) {
                showMessage("Error: No pending transaction found to confirm.", "error");
                return;
            }

            try {
                document.getElementById('successModal').classList.add('opacity-0');
                showMessage("Submitting data...", "info");

                // 1. Update Firestore status and add username
                await updateDoc(window.purchaseRef, {
                    status: 'confirmed',
                    discordUsername: discordUsername
                });

                // 2. Fetch the final data for the webhook (including the username)
                const finalSnap = await getDoc(window.purchaseRef);
                const finalData = finalSnap.data();

                // 3. Send final CONFIRMATION webhook to Discord
                await sendDiscordNotification(finalData, window.purchaseRef.id, true);

                // 4. Clear cart and delete the document (final cleanup)
                clearCart();
                await deleteDoc(window.purchaseRef);
                window.purchaseRef = null;

                document.getElementById('successModal').classList.add('hidden');
                document.getElementById('successModal').classList.remove('opacity-0');
                showMessage("Order confirmed! Discord tag submitted. Expect contact soon.", "success");

            } catch (error) {
                console.error("Error submitting Discord username:", error);
                showMessage("Confirmation failed. Refresh and retry.", "error");
            }
        }

        // Must call Firebase setup on module load
        window.setupFirebase();

    </script>


    <script>
        // Data structure for the items - **UPDATED to match new menu and pricing**
        const shopItems = [
            // Thigh Customs
            { id: 101, name: "Thigh Photo - Base", type: "Photo", basePrice: 1.00, perSecondCost: 0, desc: "A standard photo of the subject's upper leg area.", isVideo: false },
            { id: 102, name: "Thigh Photo - Highs", type: "Photo", basePrice: 2.00, perSecondCost: 0, desc: "A photo featuring the subject wearing high socks.", isVideo: false },
            { id: 103, name: "Thigh Photo - Custom Text", type: "Photo", basePrice: 3.00, perSecondCost: 0, desc: "A photo with a custom message written on the subject.", isVideo: false },
            { id: 104, name: "Thigh Squish Video", type: "Video", basePrice: 5.00, perSecondCost: 0.10, desc: "A video of the subject squeezing their upper leg area. (10s base, $1 per 10s extension)", isVideo: true },
            
            // Dick Customs
            { id: 201, name: "Bulge Photo", type: "Photo", basePrice: 3.00, perSecondCost: 0, desc: "A photo of the subject's genital area, covered.", isVideo: false },
            { id: 202, name: "Genital Photo", type: "Photo", basePrice: 5.00, perSecondCost: 0, desc: "An explicit photo of the subject's genital area.", isVideo: false },
            { id: 203, name: "Erotic Video - A", type: "Video", basePrice: 10.00, perSecondCost: 0.20, desc: "A video of self-stimulation. (10s base, $2 per 10s extension)", isVideo: true },
            { id: 204, name: "Erotic Video - B", type: "Video", basePrice: 15.00, perSecondCost: 0.30, desc: "A video of completion/release. (10s base, $3 per 10s extension)", isVideo: true },
            
            // Ass Customs
            { id: 301, name: "Ass Photo - Covered", type: "Photo", basePrice: 3.00, perSecondCost: 0, desc: "A photo of the subject's rear, covered by clothing.", isVideo: false },
            { id: 302, name: "Ass Photo - Bare", type: "Photo", basePrice: 7.00, perSecondCost: 0, desc: "An explicit photo of the subject's bare rear.", isVideo: false },
            { id: 303, name: "Anal Photo", type: "Photo", basePrice: 8.00, perSecondCost: 0, desc: "A photo of the subject's anal area.", isVideo: false },
            { id: 304, name: "Ass Squish Video", type: "Video", basePrice: 10.00, perSecondCost: 0.20, desc: "A video of the subject squeezing their rear area. (10s base, $2 per 10s extension)", isVideo: true },
            { id: 305, name: "Intimate Video", type: "Video", basePrice: 15.00, perSecondCost: 0.30, desc: "A video featuring manual intimate contact. (10s base, $3 per 10s extension)", isVideo: true }
        ];

        // Global cart array to hold selected items
        window.cart = [];
        window.tempVideoItem = null;

        // --- UTILITY FUNCTIONS ---

        function calculateItemPrice(item) {
            if (!item.isVideo) {
                return item.basePrice;
            }
            // Video Pricing: Base Price + (Extra Duration / 10) * Per 10 Sec Cost
            const extraSeconds = Math.max(0, item.duration - 10);
            const extraCost = (extraSeconds / 10) * (item.perSecondCost * 1000) / 100; // perSecondCost is cost per 10s in dollars
            return item.basePrice + extraCost;
        }

        function calculateTotal() {
            return window.cart.reduce((total, item) => total + calculateItemPrice(item) * item.quantity, 0);
        }

        function updateCartDisplay() {
            const cartDisplay = document.getElementById('cartDisplay');
            const cartTotal = document.getElementById('cartTotal');
            const cartCount = document.getElementById('cartCount');

            if (window.cart.length === 0) {
                cartDisplay.innerHTML = '<p class="italic text-gray-700">Cart is empty.</p>';
                cartTotal.innerText = '$0.00';
                cartCount.innerText = '0';
                document.getElementById('checkoutButton').disabled = true;
                return;
            }

            // Update item list
            cartDisplay.innerHTML = window.cart.map(item => {
                const totalItemPrice = calculateItemPrice(item);
                let itemDetail = `${item.quantity}x ${item.name}`;
                if (item.duration) {
                    itemDetail += ` [${item.duration}s]`;
                }
                
                return `<div class="flex justify-between items-center py-1">
                            <span class="text-red-300 font-bold">${itemDetail}</span>
                            <span class="text-white">$${(totalItemPrice * item.quantity).toFixed(2)}</span>
                        </div>`;
            }).join('');

            // Update total
            const total = calculateTotal();
            cartTotal.innerText = `$${total.toFixed(2)}`;
            cartCount.innerText = window.cart.reduce((count, item) => count + item.quantity, 0).toString();
            document.getElementById('checkoutButton').disabled = false;
        }

        function clearCart() {
            window.cart = [];
            updateCartDisplay();
            // Deselect all items in the UI
            document.querySelectorAll('.item-card').forEach(card => card.classList.remove('item-selected'));
        }

        // --- CART MANIPULATION ---

        function toggleCartItem(item) {
            if (item.isVideo) {
                // If it's a video, show the options modal instead of toggling directly
                window.tempVideoItem = item;
                document.getElementById('videoModalTitle').innerText = `Configure duration for: ${item.name}`;
                document.getElementById('videoDuration').value = 10;
                updateVideoModalTotal();
                document.getElementById('videoOptionsModal').classList.remove('hidden');
                return;
            }

            const index = window.cart.findIndex(i => i.id === item.id);
            const itemCard = document.getElementById(`item-${item.id}`);

            if (index > -1) {
                // Item is already in cart, remove it
                window.cart.splice(index, 1);
                itemCard.classList.remove('item-selected');
                showMessage(`${item.name} removed from cartel.`, 'info');
            } else {
                // Item is not in cart, add it (quantity 1, no duration needed)
                window.cart.push({ ...item, quantity: 1 });
                itemCard.classList.add('item-selected');
                showMessage(`${item.name} added to cart!`, 'success');
            }
            updateCartDisplay();
        }

        // --- VIDEO MODAL LOGIC ---

        window.updateVideoModalTotal = function() {
            if (!window.tempVideoItem) return;

            const durationInput = document.getElementById('videoDuration');
            let duration = parseInt(durationInput.value, 10);
            
            // Enforce minimum and 10-second increments
            if (isNaN(duration) || duration < 10) {
                duration = 10;
                durationInput.value = 10;
            } else if (duration % 10 !== 0) {
                duration = Math.round(duration / 10) * 10;
                durationInput.value = duration;
            }

            const tempItem = {
                ...window.tempVideoItem,
                duration: duration
            };

            const total = calculateItemPrice(tempItem);
            document.getElementById('videoModalTotal').innerText = `$${total.toFixed(2)}`;
        }

        window.addVideoToCart = function() {
            if (!window.tempVideoItem) return;

            const duration = parseInt(document.getElementById('videoDuration').value, 10);
            const itemCard = document.getElementById(`item-${window.tempVideoItem.id}`);
            
            const newItem = {
                ...window.tempVideoItem,
                quantity: 1, // Only allow one instance per custom item type in the cart for simplicity
                duration: duration,
                price: calculateItemPrice({ ...window.tempVideoItem, duration: duration }), // Store the final price for the current duration
                unitPrice: window.tempVideoItem.basePrice, // Store the base price for reference
                perSecondCost: window.tempVideoItem.perSecondCost // Store the unit cost for reference
            };

            // Check if this item is already in the cart (for simplicity, only allow one of each video type at a time)
            const existingIndex = window.cart.findIndex(i => i.id === newItem.id);
            if (existingIndex > -1) {
                window.cart[existingIndex] = newItem;
                showMessage(`${newItem.name} duration updated to ${duration}s.`, 'success');
            } else {
                window.cart.push(newItem);
                itemCard.classList.add('item-selected');
                showMessage(`${newItem.name} (${duration}s) added to cart!`, 'success');
            }
            
            document.getElementById('videoOptionsModal').classList.add('hidden');
            window.tempVideoItem = null;
            updateCartDisplay();
        }

        // --- UI RENDERING ---

        function renderShopItems() {
            const container = document.getElementById('itemContainer');
            container.innerHTML = shopItems.map(item => {
                const priceText = item.isVideo 
                    ? `$${item.basePrice.toFixed(2)} + $${(item.perSecondCost * 10).toFixed(2)}/10s`
                    : `$${item.basePrice.toFixed(2)}`;

                let categoryIcon = 'üì∏'; // Photo default
                if (item.name.includes("Video") || item.name.includes("Erotic")) {
                    categoryIcon = 'üé•';
                } else if (item.name.includes("Thigh")) {
                    categoryIcon = 'ü¶µ';
                } else if (item.name.includes("Ass")) {
                    categoryIcon = 'üçë';
                } else if (item.name.includes("Bulge") || item.name.includes("Genital")) {
                    categoryIcon = 'üçÜ'; // Placeholder for discretion
                }

                return `
                    <div id="item-${item.id}" onclick="toggleCartItem(shopItems.find(i => i.id === ${item.id}))"
                        class="item-card bg-gray-900 p-6 rounded-xl hover:bg-gray-800 transition duration-200">
                        <div class="flex items-center space-x-4">
                            <span class="text-4xl text-red-400">${categoryIcon}</span>
                            <div>
                                <h3 class="text-xl font-extrabold text-red-500">${item.name}</h3>
                                <p class="text-md text-red-300">${priceText}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-gray-400">${item.desc}</p>
                        <p class="mt-2 text-sm text-red-500 font-semibold">Click to ${item.isVideo ? 'Configure/Select' : 'Add/Remove'}!</p>
                    </div>
                `;
            }).join('');
        }

        // --- BACKGROUND CANVAS ANIMATION ---
        // (Simplified for 'spiky' effect using smaller, more numerous dots)

        let canvas, ctx, width, height, dots;
        const DOT_COUNT = 300; // More dots for a 'spiky' noise effect

        function initCanvas() {
            canvas = document.getElementById('dotCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            dots = [];
            for (let i = 0; i < DOT_COUNT; i++) {
                dots.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 1.5, // Faster movement
                    vy: (Math.random() - 0.5) * 1.5,
                    radius: Math.random() * 1.5 + 0.5, // Smaller dots
                    color: `rgba(255, 0, 0, ${Math.random() * 0.3 + 0.1})` // Red
                });
            }
        }

        function resizeCanvas() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; // Darker trail for edgy look
            ctx.fillRect(0, 0, width, height);

            dots.forEach(dot => {
                // Update position (simple boundary wrapping for continuous movement)
                dot.x += dot.vx;
                dot.y += dot.vy;

                if (dot.x < 0) dot.x = width;
                if (dot.x > width) dot.x = 0;
                if (dot.y < 0) dot.y = height;
                if (dot.y > height) dot.y = 0;

                // Draw dot
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dot.radius, 0, Math.PI * 2);
                ctx.fillStyle = dot.color;
                ctx.fill();
            });

            requestAnimationFrame(draw);
        }

        // --- INITIALIZATION ---

        window.onload = function () {
            // Setup Shop UI
            renderShopItems();
            updateCartDisplay();
            
            // Setup Background
            initCanvas();
            draw();
            
            // NOTE: Firebase setup is handled by the <script type="module"> block
        };

    </script>
</body>

</html>
