<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíñ UwU Cute Customs Shop! üíñ</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load PayPal SDK -->
    <!-- CRITICAL FIX: To resolve "Can not read window host" in iframes, we ensure the minimal parameters are used 
         and the iframe-fallback is explicitly enabled. This forces the SDK to use a secure postMessage method. -->
    <script 
        src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD" 
        data-iframe-fallback="true"
    ></script>

    <style>
        /* Changed font to Varela Round for a cute, rounded aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round:wght:400&display=swap');
        
        body {
            font-family: 'Varela Round', sans-serif;
            background-color: #000000; /* Pure Black Background */
            min-height: 100vh;
            overflow-x: hidden;
            color: #f7f7f7;
            position: relative; /* Needed for absolute canvas */
        }
        
        /* Canvas for background */
        #dotCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Keep it behind all content */
        }

        /* Container for content */
        .content-container {
            position: relative;
            z-index: 10;
            padding-top: 2rem;
            padding-bottom: 4rem;
        }

        .card {
            background-color: rgba(0, 0, 0, 0.9); /* More transparent dark card */
            border: 1px solid #111; /* Softer border */
            box-shadow: 0 0 20px rgba(255, 60, 60, 0.4); /* Brighter, softer red glow shadow */
        }
        
        /* Gradient Text Animation */
        .text-gradient {
            background-image: linear-gradient(to right, #ef4444, #dc2626, #b91c1c); /* Red-500, Red-600, Red-700 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 4s ease-in-out infinite alternate;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header-glow {
            text-shadow: 0 0 8px #ff7777, 0 0 15px #ff4444; /* Brighter, layered glow */
        }

        /* Custom Checkbox Styling (Round and Themed) */
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ef4444; /* Red-500 border */
            border-radius: 50%; /* Make it perfectly round */
            background-color: #000000; /* Black background */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
            flex-shrink: 0; /* Prevents stretching in flex container */
        }

        .custom-checkbox:checked {
            background-color: #ef4444; /* Red-500 fill when checked */
            border-color: #ef4444;
        }

        /* Custom checkmark using pseudo-element */
        .custom-checkbox:checked::after {
            content: '';
            position: absolute;
            top: 3px; 
            left: 6px; 
            width: 5px;
            height: 10px;
            border: solid #000000; /* Pure black checkmark for contrast */
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        /* Style for clickable menu bar */
        .menu-item-bar {
            cursor: pointer;
            user-select: none; /* Prevent text selection on click */
        }


        /* Custom message box styling */
        .message-box {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Custom red scrollbar for effect */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-thumb {
            background-color: #ef4444; /* Red-500 */
            border-radius: 4px;
        }
        body::-webkit-scrollbar-track {
            background: #000;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Canvas for Parallax Glowing Dots -->
    <canvas id="dotCanvas"></canvas>

    <!-- Message/Alert Box -->
    <div id="messageBox" class="message-box fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white opacity-0 transition-opacity hidden">
        <p id="messageText" class="font-semibold text-base"></p>
    </div>

    <!-- Main Content -->
    <div class="content-container container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-red-500 header-glow tracking-wider leading-tight text-gradient">
                üíñ UwU CUTE CUSTOMS MENU! üíñ
            </h1>
            <p class="text-lg text-gray-300 mt-4">
                Pwease select what you'd like, teehee~
            </p>
        </header>

        <main class="grid lg:grid-cols-3 gap-8">
            <!-- Menu Items -->
            <div id="menuContainer" class="lg:col-span-2 space-y-8">
                <!-- Menu categories will be injected here by JavaScript -->
            </div>

            <!-- Checkout Form Card -->
            <div class="lg:col-span-1 card p-6 rounded-xl border border-red-800 h-fit sticky top-8">
                <h2 class="text-3xl font-bold mb-6 text-red-500 text-gradient">‚ú® Your Cute Order! ‚≠ê</h2>
                
                <div id="orderSummary" class="text-gray-400 mb-4 h-48 overflow-y-auto pr-2">
                    <!-- Selected items will be listed here -->
                    <p class="text-center text-base italic text-gray-500">
                        Select items to begin your order, senpai~
                    </p>
                </div>
                
                <div class="flex justify-between items-center bg-gray-900 p-4 rounded-lg mb-6 border border-red-700">
                    <span class="text-xl font-semibold text-gray-100">TOTAL:</span>
                    <span id="totalPriceDisplay" class="text-4xl font-bold text-red-400 text-gradient">$0.00</span>
                </div>

                <form id="checkoutForm">
                    <div class="mb-4">
                        <label for="customerName" class="block text-base font-medium text-gray-300 mb-1">Your Name</label>
                        <input type="text" id="customerName" placeholder="Discord or Contact Name" required 
                            class="mt-1 block w-full rounded-md bg-gray-900 border border-red-800 shadow-sm p-3 text-white 
                                focus:ring-red-500 focus:border-red-500 text-base">
                    </div>

                    <div class="mb-6">
                        <label for="customerEmail" class="block text-base font-medium text-gray-300 mb-1">Your Contact Info / Email</label>
                        <input type="text" id="customerEmail" placeholder="Email or Discord Tag" required 
                            class="mt-1 block w-full rounded-md bg-gray-900 border border-red-800 shadow-sm p-3 text-white 
                                focus:ring-red-500 focus:border-red-500 text-base">
                    </div>

                    <!-- PayPal Button Container -->
                    <div id="paypal-button-container" class="mt-6">
                        <p class="text-center text-sm text-gray-500" id="paypal-message">
                            Select items and fill contact info to enable PayPal payment.
                        </p>
                    </div>
                    
                    <p class="text-xs text-red-400 mt-2 text-center">
                        ‚ö†Ô∏è **SECURITY WARNING:** Price calculation is on the client-side. For a real, secure store, this must be handled on a backend server.
                    </p>
                </form>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        // -----------------------------------------------------------------------------
        // !!! IMPORTANT: REPLACE THESE PLACEHOLDERS !!!
        // -----------------------------------------------------------------------------
        
        // 1. DISCORD WEBHOOK URL (For notifications)
        const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1437087889233154130/cMLy9vdMED5dPTEJizjWXvLhz9o7gUZ5ZvxNqDQqcqXntFNnt20fbvCRuhNR6C9X-O4t';
        
        // 2. PAYPAL CLIENT ID (MANDATORY for payments to work)
        // Get this from your PayPal Developer Dashboard (Sandbox or Live).
        // NOTE: The Client Secret is NOT needed for this client-side PayPal implementation.
        const PAYPAL_CLIENT_ID = 'BAAKIau4vqChpzxkFQzc7LARC5W1ir0tvAnIvefpWiui1R0tK8O3ue3lXdPI-GRoOxYW914pVi5jdz2LF8'; 
        
        // 3. PAYPAL MERCHANT EMAIL (MANDATORY to receive funds)
        // This is the email linked to your PayPal account.
        const PAYPAL_MERCHANT_EMAIL = 'cookiethesmolbean@gmail.com'; 
        
        const BASE_DURATION_SECONDS = 10;
        // -----------------------------------------------------------------------------
        
        // --- MENU DATA STRUCTURE ---
        const MENU_ITEMS = {
            "Thigh Customs üíñ": [
                { id: "thigh_pic", name: "Thigh pic", basePrice: 1.00, type: "static" },
                { id: "thigh_highs", name: "Thigh pic w thigh highs", basePrice: 2.00, type: "static" },
                { id: "thigh_writing", name: "Thigh pic w custom writing", basePrice: 3.00, type: "static" },
                { id: "thigh_squishes", name: "Thigh squishes vid ‚≠ê", basePrice: 5.00, costPerBlock: 1.00, type: "video" }
            ],
            "Dick Customs ‚ú®": [
                { id: "bulge_pic", name: "Bulge pic", basePrice: 3.00, type: "static" },
                { id: "dick_pic", name: "Dick pic", basePrice: 5.00, type: "static" },
                { id: "jo_vid", name: "Jerk off vid ‚≠ê", basePrice: 10.00, costPerBlock: 2.00, type: "video" },
                { id: "cum_vid", name: "Cum vid ‚ú®", basePrice: 15.00, costPerBlock: 3.00, type: "video" }
            ],
            "Ass Customs üçë": [ 
                { id: "covered_ass", name: "Covered ass pic", basePrice: 3.00, type: "static" },
                { id: "bare_ass", name: "Bare ass pic", basePrice: 7.00, type: "static" },
                { id: "anal_pic", name: "Anal pic", basePrice: 8.00, type: "static" },
                { id: "ass_squish_vid", name: "Ass squish vid ‚≠ê", basePrice: 10.00, costPerBlock: 2.00, type: "video" },
                { id: "fingering_vid", name: "Fingering vid ‚ú®", basePrice: 15.00, costPerBlock: 3.00, type: "video" }
            ]
        };

        let currentOrder = [];
        let paypalButtonsRendered = false; // Flag to prevent multiple button renders

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Displays a temporary, self-hiding message box.
         */
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-yellow-600');
            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600'); 
            } else {
                messageBox.classList.add('bg-yellow-600'); 
            }

            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('opacity-100'); }, 10); 

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                setTimeout(() => { messageBox.classList.add('hidden'); }, 300);
            }, 5000);
        }

        /**
         * Calculates the price for a video item.
         */
        function calculateVideoPrice(item, durationSeconds) {
            // Note: durationSeconds should already be a multiple of BASE_DURATION_SECONDS here
            const effectiveDuration = Math.max(0, durationSeconds - BASE_DURATION_SECONDS);
            const blocks = Math.ceil(effectiveDuration / BASE_DURATION_SECONDS); 
            const additionalCost = blocks * item.costPerBlock;
            return item.basePrice + additionalCost;
        }
        
        /**
         * Finds item data by ID.
         */
        function findItemById(id) {
            for (const category of Object.values(MENU_ITEMS)) {
                const item = category.find(i => i.id === id);
                if (item) return item;
            }
            return null;
        }

        // --- CORE LOGIC FUNCTIONS ---

        /**
         * Recalculates the total price based on the current state of all checkboxes and video inputs.
         * This is the source of truth for the PayPal transaction.
         */
        function getRecalculatedTotal() {
            let verifiedTotal = 0;
            
            // Loop through all categories and items
            for (const category of Object.values(MENU_ITEMS)) {
                for (const item of category) {
                    const checkbox = document.getElementById(`item_${item.id}`);

                    if (checkbox && checkbox.checked) {
                        let itemPrice = item.basePrice;

                        if (item.type === 'video') {
                            const durationInput = document.getElementById(`duration_${item.id}`);
                            // Ensure the duration is read, defaults to base if empty/invalid
                            const duration = parseInt(durationInput?.value) || BASE_DURATION_SECONDS;
                            
                            // Re-apply the duration rounding logic for price integrity check
                            const correctedDuration = Math.max(BASE_DURATION_SECONDS, Math.ceil(duration / BASE_DURATION_SECONDS) * BASE_DURATION_SECONDS);
                            itemPrice = calculateVideoPrice(item, correctedDuration);
                        }
                        
                        verifiedTotal += itemPrice;
                    }
                }
            }
            // Return to 2 decimal places for currency
            return parseFloat(verifiedTotal.toFixed(2));
        }


        /**
         * Toggles the selection of a menu item based on the bar click.
         */
        function toggleItemSelection(itemId) {
            const checkbox = document.getElementById(`item_${itemId}`);
            const durationInput = document.getElementById(`duration_${itemId}`);
            
            // Toggle the checkbox state
            checkbox.checked = !checkbox.checked;
            
            // Manually trigger update order, passing the checkbox element
            updateOrder({ target: checkbox }, itemId);
            
            // If it's a video and just got checked, focus the duration input
            if (checkbox.checked && durationInput) {
                 durationInput.focus();
            }
        }
        
        /**
         * Updates the internal currentOrder array based on user input.
         */
        function updateOrder(event, itemId) {
            const isCheckbox = event.target.type === 'checkbox';
            const isChecked = isCheckbox ? event.target.checked : document.getElementById(`item_${itemId}`).checked;
            const itemData = findItemById(itemId);
            if (!itemData) return;

            // Remove existing item from the order array
            currentOrder = currentOrder.filter(orderItem => orderItem.id !== itemId);
            
            if (isChecked) {
                let price = itemData.basePrice;
                let duration = null;

                if (itemData.type === 'video') {
                    const durationInput = document.getElementById(`duration_${itemId}`);
                    duration = parseInt(durationInput.value) || BASE_DURATION_SECONDS;
                    
                    // Enforce block duration
                    if (duration < BASE_DURATION_SECONDS || duration % BASE_DURATION_SECONDS !== 0) {
                        duration = Math.max(BASE_DURATION_SECONDS, Math.ceil(duration / BASE_DURATION_SECONDS) * BASE_DURATION_SECONDS);
                        durationInput.value = duration;
                        if (!isCheckbox) {
                            showMessage('Duration corrected to a multiple of 10 seconds, nya!', 'warning');
                        }
                    }
                    price = calculateVideoPrice(itemData, duration);
                }
                
                currentOrder.push({ 
                    id: itemId, 
                    name: itemData.name, 
                    price: price, 
                    duration: duration 
                });
            } else {
                // If unchecked, ensure video input resets to base value
                if (itemData.type === 'video' && document.getElementById(`duration_${itemId}`)) {
                    document.getElementById(`duration_${itemId}`).value = BASE_DURATION_SECONDS;
                }
            }

            calculateAndRenderTotal();
        }

        /**
         * Calculates and updates the total price, summary display, and PayPal button.
         */
        function calculateAndRenderTotal() {
            // Get the total from the source of truth
            let total = getRecalculatedTotal();
            const totalPriceDisplay = document.getElementById('totalPriceDisplay');
            const orderSummary = document.getElementById('orderSummary');
            const customerName = document.getElementById('customerName').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const paypalMessage = document.getElementById('paypal-message');
            
            totalPriceDisplay.textContent = `$${total.toFixed(2)}`;
            
            // 1. Render Order Summary
            if (currentOrder.length === 0) {
                orderSummary.innerHTML = '<p class="text-center text-base italic text-gray-500">Select items to begin your order, senpai~</p>';
            } else {
                // Sort currentOrder to match the order summary rendering logic
                const sortedOrder = [...currentOrder].sort((a, b) => a.id.localeCompare(b.id));

                orderSummary.innerHTML = sortedOrder.map(item => {
                    const durationStr = item.duration ? ` (${item.duration} sec)` : '';
                    return `<div class="flex justify-between border-b border-gray-900 py-1 text-base">
                                <span>${item.name}${durationStr}</span>
                                <span class="text-red-400 font-bold">$${item.price.toFixed(2)}</span>
                            </div>`;
                }).join('');
            }
            
            // 2. Control PayPal Button Visibility and Rendering
            const isOrderValid = currentOrder.length > 0 && customerName.length > 0 && customerEmail.length > 0;

            if (isOrderValid && total > 0) {
                paypalMessage.style.display = 'none';
                renderPayPalButton(total.toFixed(2));
            } else {
                // Clear the container if order is invalid/zero
                document.getElementById('paypal-button-container').innerHTML = '';
                paypalButtonsRendered = false; // Reset flag
                paypalMessage.style.display = 'block';
                if (currentOrder.length === 0) {
                    paypalMessage.textContent = 'Select items to enable payment, senpai~';
                } else {
                    paypalMessage.textContent = 'Please fill in your name and contact info! ^_^';
                }
            }
        }
        
        /**
         * Renders the PayPal buttons using the SDK.
         */
        function renderPayPalButton(displayedTotalAmount) {
            const container = document.getElementById('paypal-button-container');
            
            // Check if PayPal is available and if buttons are already rendered
            if (typeof paypal === 'undefined') {
                // If SDK failed to load, show a manual error message
                 container.innerHTML = `<p class="text-red-500 font-bold text-center">
                    Payment System Error: PayPal SDK failed to load. Please check the console.
                </p>`;
                return;
            }

            if (paypalButtonsRendered) {
                // Buttons are already there, nothing to do
                return;
            }

            // Set the flag to true before rendering
            paypalButtonsRendered = true;


            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'gold', 
                    shape: 'pill',
                    label: 'paypal'
                },
                
                // Set up the transaction (called when the button is clicked)
                createOrder: function(data, actions) {
                    
                    // --- CRITICAL PRICE INTEGRITY CHECK ---
                    const verifiedTotal = getRecalculatedTotal().toFixed(2);

                    // Check for zero or invalid amount
                    if (parseFloat(verifiedTotal) <= 0 || isNaN(parseFloat(verifiedTotal))) {
                        showMessage(`Price calculation error or zero total. Payment canceled.`, 'error');
                        throw new Error("Zero or invalid total detected.");
                    }
                    
                    // If the check passes, proceed with order creation using the verified total
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: verifiedTotal, // Use the verified total amount
                                currency_code: 'USD'
                            },
                            payee: {
                                // IMPORTANT: This must be your actual PayPal business email
                                email_address: PAYPAL_MERCHANT_EMAIL 
                            },
                            custom_id: document.getElementById('customerName').value, 
                        }]
                    });
                },

                // Finalize the transaction (called after buyer approves)
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(orderData) {
                        // PAYMENT SUCCESSFUL!
                        showMessage('Payment Approved! Preparing your custom order...', 'success');
                        
                        const customerName = document.getElementById('customerName').value.trim();
                        const customerEmail = document.getElementById('customerEmail').value.trim();
                        
                        // We use the total from the orderData for the final webhook notification
                        const finalPaidAmount = orderData.purchase_units[0].payments.captures[0].amount.value;

                        sendDiscordNotification(
                            currentOrder, 
                            finalPaidAmount, 
                            customerName, 
                            customerEmail, 
                            orderData.id 
                        );
                        
                        // Clear the form after success
                        document.getElementById('checkoutForm').reset();
                        currentOrder = [];
                        document.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
                        document.querySelectorAll('.duration-input').forEach(input => { input.value = BASE_DURATION_SECONDS; });
                        paypalButtonsRendered = false; // Reset flag
                        calculateAndRenderTotal(); // This will clear summary and hide button
                    });
                },
                
                // Handle cancellation
                onCancel: function (data) {
                    showMessage('Order cancelled by user, teehee!', 'warning');
                    console.log('Order Cancelled:', data);
                    // Resetting the flag here ensures the button is re-rendered if the user tries again
                    paypalButtonsRendered = false; 
                    calculateAndRenderTotal(); 
                },

                // Handle error
                onError: function (err) {
                    showMessage('An error occurred during payment. Please check console.', 'error');
                    console.error('PayPal Error:', err);
                    // Resetting the flag here ensures the button is re-rendered if the user tries again
                    paypalButtonsRendered = false; 
                    calculateAndRenderTotal(); 
                }
            }).render('#paypal-button-container');
        }

        /**
         * Sends a formatted message to the Discord webhook.
         */
        async function sendDiscordNotification(order, total, contactName, contactEmail, paypalOrderId) {
            if (DISCORD_WEBHOOK_URL === 'YOUR_DISCORD_WEBHOOK_URL_HERE') {
                console.warn("Webhook URL is not set. Notification skipped. Set DISCORD_WEBHOOK_URL to enable.");
                return;
            }

            const timestamp = new Date().toISOString();
            
            const orderFields = order.map(item => {
                const duration = item.duration ? ` (${item.duration} sec)` : '';
                return { 
                    name: `üõí ${item.name}${duration}`, 
                    value: `Price: **$${item.price.toFixed(2)}**`, 
                    inline: false 
                };
            });
            
            const contactFields = [
                { name: "‚ú® Order Status", value: "**PAID (via PayPal)**", inline: false },
                { name: "üë§ Customer Name", value: contactName, inline: true },
                { name: "üìß Contact Info", value: contactEmail, inline: true },
                { name: "‚≠ê PayPal Order ID", value: paypalOrderId || 'N/A', inline: false },
                ...orderFields,
                { name: "üí∞ TOTAL PAID", value: `**$${total}**`, inline: false }
            ];

            const webhookData = {
                username: "üéÄ Cute Order Bot üéÄ",
                avatar_url: "https://placehold.co/100x100/dc2626/000000?text=UwU",
                embeds: [
                    {
                        title: "üíñ KAWAII NEW PAID CUSTOM ORDER RECEIVED! üíñ",
                        description: `A new custom request has been successfully **PAID** for a total of **$${total}**!`,
                        color: 14766080, // Red color code
                        fields: contactFields,
                        footer: {
                            text: `Order Processed at ${new Date().toLocaleTimeString()} (Eastern) ~ <3`
                        },
                        timestamp: timestamp
                    }
                ]
            };

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookData)
                });

                if (response.ok || response.status === 204) {
                    showMessage('Webhook notification sent successfully!', 'success');
                } else {
                    throw new Error(`Webhook failed with status: ${response.status}. Response: ${await response.text()}`);
                }
            } catch (error) {
                showMessage(`Oh noes! Webhook Notification FAILED. Check console for details.`, 'error');
                console.error("Error sending Discord notification:", error);
            }
        }


        // --- CANVAS BACKGROUND LOGIC (UNCHANGED) ---
        const canvas = document.getElementById('dotCanvas');
        const ctx = canvas.getContext('2d');
        let dots = [];
        let mouse = { x: 0, y: 0 };
        const DOT_COUNT = 150; 

        class Dot {
            constructor(x, y, radius, color) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.baseRadius = radius;
                this.color = color;
                this.parallaxDepth = Math.random() * 0.5 + 0.1; 
                this.originalX = x;
                this.originalY = y;
                
                this.driftY = Math.random() * 0.2 + 0.05; 
                this.sineOffset = Math.random() * 100; 
                this.glowEffect = Math.random() * Math.PI * 2; 
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.shadowColor = 'rgba(255, 60, 60, 0.7)'; 
                ctx.shadowBlur = this.radius * 2; 
                ctx.fill();
                ctx.closePath();
            }

            update(mouseX, mouseY) {
                this.originalY += this.driftY;
                this.originalX += Math.sin(Date.now() * 0.0003 + this.sineOffset) * 0.03; 
                
                if (this.originalY > canvas.height + this.baseRadius) {
                    this.originalY = -this.baseRadius; 
                    this.originalX = Math.random() * canvas.width; 
                }

                this.x = this.originalX + (mouseX - canvas.width / 2) * this.parallaxDepth * 0.05;
                this.y = this.originalY + (mouseY - canvas.height / 2) * this.parallaxDepth * 0.05;

                const dx = mouseX - this.x;
                const dy = mouseY - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                const maxDistance = 150; 
                let proximity = Math.max(0, maxDistance - distance) / maxDistance; 
                
                this.glowEffect += 0.05; 
                const pulse = (Math.sin(this.glowEffect) * 0.5 + 0.5) * 0.5; 
                
                const maxGlowRadius = this.baseRadius * 2.5; 
                this.radius = this.baseRadius + (maxGlowRadius - this.baseRadius) * proximity + (this.baseRadius * pulse * proximity);

                const baseOpacity = 0.1 + (pulse * 0.05); 
                this.color = proximity > 0.1 
                    ? `rgba(255, ${Math.floor(100 + pulse * 100)}, ${Math.floor(100 + pulse * 100)}, ${0.4 + proximity * 0.6})` 
                    : `rgba(255, 255, 255, ${baseOpacity})`;
            }
        }

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            dots = []; 
            for (let i = 0; i < DOT_COUNT; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 1.5 + 0.8; 
                dots.push(new Dot(x, y, radius, 'rgba(255, 255, 255, 0.1)'));
            }
        }
        
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.shadowBlur = 0; 
            dots.forEach(dot => {
                dot.update(mouse.x, mouse.y);
                dot.draw();
            });
            requestAnimationFrame(animate);
        }

        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        window.addEventListener('resize', () => {
            initCanvas();
        });
        
        // --- INITIALIZATION ---
        window.toggleItemSelection = toggleItemSelection;
        window.updateOrder = updateOrder;

        document.addEventListener('DOMContentLoaded', () => {
            
            // IMPORTANT: Update the PayPal SDK script with your client ID
            const paypalScript = document.querySelector('script[src^="https://www.paypal.com/sdk/js"]');
            
            // Check if a valid ID is provided. If so, replace the 'sb' (Sandbox) tag in the SDK URL.
            if (PAYPAL_CLIENT_ID && PAYPAL_CLIENT_ID !== 'YOUR_PAYPAL_CLIENT_ID_HERE') {
                 // The SDK URL is updated to use your provided Client ID for actual transactions/testing.
                 paypalScript.src = paypalScript.src.replace('client-id=sb', `client-id=${PAYPAL_CLIENT_ID}`);
            } else {
                 showMessage('Warning: PayPal is running in **Sandbox** mode (using `client-id=sb`). Replace PAYPAL_CLIENT_ID in the CONFIGURATION block to use your account!', 'warning');
            }

            renderMenu();
            calculateAndRenderTotal();
            
            initCanvas();
            animate();
            
            // Re-calculate total whenever contact inputs change (to enable/disable PayPal button)
            document.getElementById('customerName').addEventListener('input', calculateAndRenderTotal);
            document.getElementById('customerEmail').addEventListener('input', calculateAndRenderTotal);
            
            // Prevent default form submission (PayPal SDK handles the transaction)
            document.getElementById('checkoutForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const total = getRecalculatedTotal();
                if (total > 0 && document.getElementById('customerName').checkValidity() && document.getElementById('customerEmail').checkValidity()) {
                     showMessage('You are ready to pay! Please click the PayPal button.', 'success');
                } else {
                     showMessage('H-hey! Please select items and fill all contact fields!', 'warning');
                }
            });
        });

        /**
         * Renders the menu items from the data structure.
         */
        function renderMenu() {
            const container = document.getElementById('menuContainer');
            let html = '';

            for (const [category, items] of Object.entries(MENU_ITEMS)) {
                html += `
                    <div class="card p-6 rounded-xl border-t-4 border-red-600">
                        <h3 class="text-2xl font-bold mb-4 text-red-500 text-gradient">${category}</h3>
                        <div class="space-y-4">
                `;

                items.forEach(item => {
                    const priceString = item.type === 'video'
                        ? `$${item.basePrice.toFixed(2)} + $${item.costPerBlock.toFixed(2)} per ${BASE_DURATION_SECONDS} sec`
                        : `$${item.basePrice.toFixed(2)}`;

                    html += `
                        <div class="menu-item-bar flex flex-col md:flex-row justify-between items-start md:items-center p-3 rounded-lg bg-gray-950 transition hover:bg-red-900/40 border border-gray-800"
                             onclick="toggleItemSelection('${item.id}')">
                            <div class="flex-grow">
                                <span class="text-lg font-medium text-gray-200">${item.name}</span>
                                <span class="block text-sm text-gray-400 md:inline md:ml-4">(${priceString})</span>
                            </div>
                            <div class="flex items-center mt-2 md:mt-0 space-x-2">
                    `;
                    
                    if (item.type === 'video') {
                        html += `
                                <input type="number" id="duration_${item.id}" min="${BASE_DURATION_SECONDS}" value="${BASE_DURATION_SECONDS}" step="${BASE_DURATION_SECONDS}" data-item-id="${item.id}" 
                                    class="w-20 text-center rounded-md bg-gray-800 border border-red-700 p-1 text-red-400 
                                        focus:ring-red-500 duration-input text-base" 
                                    onchange="updateOrder(event, '${item.id}')"
                                    onclick="event.stopPropagation()">
                                <span class="text-sm text-gray-400">sec</span>
                        `;
                    }
                    
                    html += `
                                <input type="checkbox" id="item_${item.id}" data-item-id="${item.id}"
                                    class="custom-checkbox"
                                    onchange="updateOrder(event, '${item.id}')"
                                    onclick="event.stopPropagation()">
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            }
            container.innerHTML = html;
        }

    </script>
</body>
</html>
