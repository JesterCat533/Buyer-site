<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> UwU Cute Customs Shop!</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Style Block -->
    <style>
        /* Changed font to Varela Round for a cute, rounded aesthetic */
        @import url('https://fonts.googleapis.com/css?family=Varela+Round:wght:400&display=swap');

        body {
            font-family: 'Varela Round', sans-serif;
            background-color: #000000;
            /* Pure Black Background */
            min-height: 100vh;
            overflow-x: hidden;
            color: #f7f7f7;
            position: relative;
        }

        /* Canvas for background */
        #dotCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Container for content */
        .content-container {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* Custom scrollbar for cuteness */
        ::-webkit-scrollbar {
            width: 12px;
            background-color: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            background-color: #ff99cc;
            /* UwU Pink */
            border: 3px solid #1a1a1a;
        }

        ::-webkit-scrollbar-track {
            border-radius: 10px;
            background-color: #1a1a1a;
        }

        /* Item card style */
        .item-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            /* Initial border */
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 153, 204, 0.3);
            /* Pink glow */
        }

        /* Custom checkout button style */
        .checkout-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 153, 204, 0.6);
            /* Pink shadow */
            background: linear-gradient(145deg, #ff99cc, #ff66b2);
            /* Pink gradient */
        }

        .checkout-button:hover {
            background: linear-gradient(145deg, #ff66b2, #ff99cc);
            box-shadow: 0 6px 20px rgba(255, 153, 204, 0.8);
            transform: translateY(-2px);
        }

        /* Custom pink border for selected item */
        .item-selected {
            border-color: #ff99cc;
            box-shadow: 0 0 15px rgba(255, 153, 204, 0.8);
        }

        /* Modal styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1a1a1a;
            /* Dark background */
            border: 3px solid #ff99cc;
            /* Pink border */
            box-shadow: 0 10px 30px rgba(255, 153, 204, 0.8);
            /* Strong pink glow */
        }
    </style>
</head>

<body class="selection:bg-pink-300 selection:text-black">

    <!-- Canvas for background dots/stars -->
    <canvas id="dotCanvas"></canvas>

    <!-- Main Content Container -->
    <div class="content-container">

        <!-- Header -->
        <header class="py-6 border-b-2 border-pink-400/30 mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-400 text-center">
                ‚ú® UwU Cute Customs Shop! ‚ú®
            </h1>
            <p id="userIdDisplay" class="text-xs text-pink-300/70 text-center mt-2">
                System Initializing...
            </p>
        </header>

        <!-- Notification Message Box (for warnings/success) -->
        <div id="messageBox" class="fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-500 opacity-0 hidden"
            role="alert">
            <div id="messageText" class="font-bold"></div>
        </div>

        <!-- Section: Available Items -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-pink-300 mb-6 text-center">Available Cute Customs</h2>
            <div id="itemContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Item cards will be injected here by JavaScript -->
            </div>
        </section>

        <!-- Section: Cart and Checkout -->
        <section class="sticky bottom-0 bg-black/90 backdrop-blur-sm py-4 border-t-2 border-pink-400/30 rounded-t-xl">
            <div class="flex flex-col md:flex-row justify-between items-center px-4">
                <!-- Cart Summary -->
                <div class="flex-grow mb-4 md:mb-0">
                    <h3 class="text-2xl font-bold text-pink-300">Your Cart (<span id="cartCount">0</span> Items)</h3>
                    <div id="cartDisplay" class="text-sm text-gray-300 min-h-[20px] max-h-[100px] overflow-y-auto pr-2">
                        <!-- Cart items will be displayed here -->
                        <p class="italic text-gray-500">Cart is empty.</p>
                    </div>
                </div>

                <!-- Total and Checkout Button -->
                <div class="flex flex-col items-center space-y-2 md:space-y-0 md:space-x-4 md:flex-row">
                    <p class="text-xl font-bold text-white">Total: <span id="cartTotal" class="text-green-400">$0.00</span></p>
                    <button id="checkoutButton" onclick="handleCheckout()"
                        class="checkout-button text-black font-extrabold py-3 px-8 rounded-full text-lg uppercase tracking-wider hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        Checkout Now!
                    </button>
                </div>
            </div>
        </section>

    </div>

    <!-- START OF CUSTOM MODALS -->

    <!-- 1. Payment Prompt Modal -->
    <div id="paymentModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content w-11/12 md:w-1/3 p-6 md:p-8 rounded-2xl text-center">
            <h3 class="text-3xl font-extrabold text-pink-400 mb-4">Manual Payment Required!</h3>
            <p class="text-lg text-gray-200 mb-6">
                Please manually send the exact amount shown below to
                <a href="https://paypal.me/CookieCutie167" target="_blank" class="text-blue-400 hover:text-blue-300 underline">
                    https://paypal.me/CookieCutie167
                </a>
                to complete your purchase.
            </p>

            <div class="bg-gray-800 p-4 rounded-xl mb-6 border border-pink-500/50">
                <p class="text-2xl font-bold text-green-400">Total Amount: <span id="paymentAmount">$0.00</span></p>
            </div>

            <a id="paymentLink" target="_blank"
                class="block w-full text-black font-extrabold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out mb-4"
                style="background: linear-gradient(145deg, #ff99cc, #ff66b2);">
                Click to Open PayPal Payment Link
            </a>

            <button onclick="handlePaymentConfirmation()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out">
                I have paid! (Click here after sending money)
            </button>
            <p class="text-sm text-gray-400 mt-3">
                <span class="font-bold text-red-400">NOTE:</span> Your purchase will be automatically cancelled if not confirmed in 10 minutes.
            </p>
        </div>
    </div>

    <!-- 2. Discord Confirmation Modal -->
    <div id="successModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content w-11/12 md:w-1/3 p-6 md:p-8 rounded-2xl text-center">
            <h3 class="text-3xl font-extrabold text-green-400 mb-4">Purchase Successful!</h3>
            <p class="text-lg text-gray-200 mb-6">
                Thank you! Please enter your Discord username below so we can contact you to fulfill your custom order.
            </p>

            <input type="text" id="discordUsernameInput" placeholder="YourDiscordUsername#1234"
                class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white border border-pink-400 focus:border-pink-500 focus:ring-1 focus:ring-pink-500"
                required>

            <button onclick="submitDiscordUsername()"
                class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-full text-lg uppercase tracking-wider transition duration-300 ease-in-out">
                Confirm & Submit Username
            </button>
        </div>
    </div>

    <!-- END OF CUSTOM MODALS -->

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.purchaseRef = null; // Stores the document reference for the current pending purchase

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Constants for the new checkout system
        window.PAYPAL_MAIL = "CookieCutie167";
        window.PAYPAL_ME_URL = `https://paypal.me/${window.PAYPAL_MAIL}/`;
        window.DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1437087889233154130/cMLy9vdMED5dPTEJizjWXvLhz9o7gUZ5ZvxNqDQqcqXntFNnt20fbvCRuhNR6C9X-O4t";
        window.PURCHASE_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

        // Utility to display messages
        window.showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.innerText = message;
            
            // Set colors based on type
            let bgColor = 'bg-gray-700';
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'warning') bgColor = 'bg-yellow-500';
            
            messageBox.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-500 ${bgColor}`;
            messageBox.classList.remove('opacity-0', 'hidden');

            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 500);
            }, 5000);
        };

        // Firebase Setup and Authentication (Guest Login)
        window.setupFirebase = async function () {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug');

                // Sign in logic
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('userIdDisplay').innerText = `Guest ID: ${window.userId}`;
                        // Check if the user has a pending purchase from a previous session
                        checkPendingPurchase();
                    } else {
                        console.error("Authentication failed. Cannot get user ID.");
                    }
                });

            } catch (error) {
                console.error("Firebase setup failed:", error);
                showMessage("Could not connect to the database. Checkout disabled.", "error");
                document.getElementById('checkoutButton').disabled = true;
            }
        }

        // --- DISCORD WEBHOOK LOGIC ---
        window.sendDiscordNotification = async function (purchaseData, docId, isConfirmation = false) {
            const statusText = isConfirmation ? "PURCHASE CONFIRMED!" : "NEW PENDING PURCHASE";
            const color = isConfirmation ? 65280 : 16776960; // Green for confirmed, Yellow for pending
            const details = purchaseData.cart.map(item => `- **${item.quantity}x** ${item.name} (${item.type})`).join('\n');

            const embed = {
                title: `[${statusText}] - Order #${docId.substring(0, 8)}`,
                color: color,
                description: isConfirmation 
                    ? `Order fulfilled for **$${purchaseData.totalAmount.toFixed(2)}**.\n\n**Discord User:** ${purchaseData.discordUsername}`
                    : `Order initiated for **$${purchaseData.totalAmount.toFixed(2)}**.\n\n**Awaiting payment confirmation...**`,
                fields: [
                    { name: "üõí Cart Items", value: details, inline: false },
                    { name: "üíµ Total Amount", value: `$${purchaseData.totalAmount.toFixed(2)}`, inline: true },
                    { name: "üë§ Guest ID", value: purchaseData.userId, inline: true },
                    { name: "‚è≥ Expires", value: new Date(purchaseData.cleanupTimer).toLocaleString(), inline: false }
                ],
                timestamp: new Date().toISOString(),
                footer: { text: "UwU Customs Shop System" }
            };

            try {
                await fetch(window.DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ embeds: [embed] })
                });
                console.log("Discord notification sent successfully.");
            } catch (error) {
                console.error("Failed to send Discord notification:", error);
            }
        };

        // --- PENDING PURCHASE MANAGEMENT ---

        // Check if the current user has a pending purchase on page load/auth complete
        window.checkPendingPurchase = async function () {
            if (!window.userId) return;

            const purchasesColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/pending_purchases`);
            const q = query(purchasesColRef, where("status", "==", "pending"));

            try {
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No pending purchases found for this user.");
                    return;
                }

                // Assuming only one pending purchase per user
                const pendingDoc = querySnapshot.docs[0];
                window.purchaseRef = doc(window.db, pendingDoc.ref.path);
                const pendingData = pendingDoc.data();

                // Check for client-side expiration
                if (pendingData.cleanupTimer < Date.now()) {
                    await checkAndCleanupPurchase(pendingDoc.id);
                    return;
                }

                // User returned with a pending payment. Show payment modal again.
                document.getElementById('paymentAmount').innerText = `$${pendingData.totalAmount.toFixed(2)}`;
                document.getElementById('paymentLink').href = `${window.PAYPAL_ME_URL}${pendingData.totalAmount.toFixed(2)}`;
                document.getElementById('paymentModal').classList.remove('hidden');
                showMessage(`Welcome back! You have a pending purchase of $${pendingData.totalAmount.toFixed(2)}. Please complete payment.`, "warning");
                
                // Re-start the cleanup timer
                setTimeout(() => checkAndCleanupPurchase(pendingDoc.id), pendingData.cleanupTimer - Date.now());

            } catch (error) {
                console.error("Error checking pending purchase:", error);
            }
        }

        // Delete purchase if time runs out
        window.checkAndCleanupPurchase = async function (docId) {
            if (!window.db || !window.userId) return;

            const purchaseDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/pending_purchases/${docId}`);

            try {
                const docSnap = await getDoc(purchaseDocRef);
                if (docSnap.exists() && docSnap.data().status === 'pending') {
                    await deleteDoc(purchaseDocRef);
                    console.log(`Pending purchase ${docId} cleaned up due to 10-minute timeout.`);
                    showMessage("Your pending checkout was automatically cancelled due to timeout.", "error");
                    if (window.purchaseRef && window.purchaseRef.id === docId) {
                         window.purchaseRef = null;
                         document.getElementById('paymentModal').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error("Error during cleanup:", error);
            }
        }

        // --- NEW CHECKOUT HANDLERS ---

        window.handleCheckout = async function () {
            if (!window.userId || !window.db) {
                showMessage("System initializing... Please wait a moment.", "error");
                return;
            }

            const total = calculateTotal();
            if (total === 0) {
                showMessage("Your cart is empty! Add an item first, UwU.", "warning");
                return;
            }

            const cartDetails = window.cart.map(item => ({
                name: item.name,
                type: item.type,
                price: item.price,
                quantity: item.quantity
            }));

            const purchaseData = {
                userId: window.userId,
                totalAmount: total,
                cart: cartDetails,
                timestamp: serverTimestamp(),
                status: 'pending',
                cleanupTimer: Date.now() + window.PURCHASE_TIMEOUT_MS,
                discordUsername: null
            };

            document.getElementById('checkoutButton').disabled = true;

            try {
                // 1. Save pending purchase to Firestore (Private collection)
                const purchasesColRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/pending_purchases`);
                window.purchaseRef = await addDoc(purchasesColRef, purchaseData);

                // 2. Send Initial Discord Webhook
                await sendDiscordNotification(purchaseData, window.purchaseRef.id, false);

                // 3. Show Payment Modal
                document.getElementById('paymentAmount').innerText = `$${total.toFixed(2)}`;
                document.getElementById('paymentLink').href = `${window.PAYPAL_ME_URL}${total.toFixed(2)}`;
                document.getElementById('paymentModal').classList.remove('hidden');

                // 4. Start 10-minute cleanup check
                setTimeout(() => checkAndCleanupPurchase(window.purchaseRef.id), window.PURCHASE_TIMEOUT_MS);
                
                showMessage("Purchase initiated! Please send payment now.", "info");

            } catch (error) {
                console.error("Checkout failed:", error);
                showMessage("Checkout process failed due to a system error. Please try again.", "error");
                if (window.purchaseRef) {
                    await deleteDoc(window.purchaseRef);
                    window.purchaseRef = null;
                }
            } finally {
                document.getElementById('checkoutButton').disabled = false;
            }
        }

        window.handlePaymentConfirmation = function () {
            if (!window.purchaseRef) {
                showMessage("Error: No pending purchase found.", "error");
                return;
            }
            // Hide payment modal, show success/discord confirmation modal
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('hidden');
        }

        window.submitDiscordUsername = async function () {
            const discordUsername = document.getElementById('discordUsernameInput').value.trim();
            if (!discordUsername) {
                showMessage("Please enter your Discord username to complete the order.", "warning");
                return;
            }

            if (!window.purchaseRef) {
                showMessage("Error: No pending purchase found to confirm.", "error");
                return;
            }

            try {
                document.getElementById('successModal').classList.add('opacity-0');
                showMessage("Sending confirmation...", "info");

                // 1. Update Firestore status and add username
                await updateDoc(window.purchaseRef, {
                    status: 'confirmed',
                    discordUsername: discordUsername
                });

                // 2. Fetch the final data for the webhook (including the username)
                const finalSnap = await getDoc(window.purchaseRef);
                const finalData = finalSnap.data();

                // 3. Send final CONFIRMATION webhook to Discord
                await sendDiscordNotification(finalData, window.purchaseRef.id, true);

                // 4. Clear cart and delete the document (final cleanup)
                clearCart();
                await deleteDoc(window.purchaseRef);
                window.purchaseRef = null;

                document.getElementById('successModal').classList.add('hidden');
                document.getElementById('successModal').classList.remove('opacity-0');
                showMessage("Order confirmed! Your Discord username has been submitted. Thank you!", "success");

            } catch (error) {
                console.error("Error submitting Discord username:", error);
                showMessage("Confirmation failed. Please refresh and try confirming again.", "error");
            }
        }

        // Must call Firebase setup on module load
        window.setupFirebase();

    </script>


    <!-- Original Website Script (Modified) -->
    <script>
        // Data structure for the items
        const shopItems = [
            { id: 1, name: "Pixel Art Avatar", type: "Digital Art", price: 25.00, desc: "A custom, cute pixel art portrait of your choice.", imageUrl: "https://placehold.co/100x100/ff99cc/000?text=Pixel" },
            { id: 2, name: "Animated Emoji Pack", type: "Animation", price: 40.00, desc: "5 custom animated emojis for Discord or Twitch.", imageUrl: "https://placehold.co/100x100/ff66b2/000?text=Emoji" },
            { id: 3, name: "Twitch Emote (Static)", type: "Digital Art", price: 15.00, desc: "One static emote for use on streaming platforms.", imageUrl: "https://placehold.co/100x100/ff3399/000?text=Emote" },
            { id: 4, name: "Full Character Sheet", type: "Digital Art", price: 80.00, desc: "Detailed, full-body character art with three views.", imageUrl: "https://placehold.co/100x100/cc3399/000?text=Char" },
            { id: 5, name: "Simple Banner Design", type: "Graphic Design", price: 35.00, desc: "Header/banner for social media with a cute theme.", imageUrl: "https://placehold.co/100x100/aa0066/000?text=Banner" }
        ];

        // Global cart array to hold selected items
        window.cart = [];

        // --- UTILITY FUNCTIONS ---

        function calculateTotal() {
            return window.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        function updateCartDisplay() {
            const cartDisplay = document.getElementById('cartDisplay');
            const cartTotal = document.getElementById('cartTotal');
            const cartCount = document.getElementById('cartCount');

            if (window.cart.length === 0) {
                cartDisplay.innerHTML = '<p class="italic text-gray-500">Cart is empty.</p>';
                cartTotal.innerText = '$0.00';
                cartCount.innerText = '0';
                document.getElementById('checkoutButton').disabled = true;
                return;
            }

            // Update item list
            cartDisplay.innerHTML = window.cart.map(item =>
                `<div class="flex justify-between items-center py-1">
                    <span class="text-pink-300 font-bold">${item.quantity}x ${item.name}</span>
                    <span class="text-white">$${(item.price * item.quantity).toFixed(2)}</span>
                </div>`
            ).join('');

            // Update total
            const total = calculateTotal();
            cartTotal.innerText = `$${total.toFixed(2)}`;
            cartCount.innerText = window.cart.reduce((count, item) => count + item.quantity, 0).toString();
            document.getElementById('checkoutButton').disabled = false;
        }

        function clearCart() {
            window.cart = [];
            updateCartDisplay();
            // Deselect all items in the UI
            document.querySelectorAll('.item-card').forEach(card => card.classList.remove('item-selected'));
        }

        // --- CART MANIPULATION ---

        function toggleCartItem(item) {
            const index = window.cart.findIndex(i => i.id === item.id);
            const itemCard = document.getElementById(`item-${item.id}`);

            if (index > -1) {
                // Item is already in cart, remove it
                window.cart.splice(index, 1);
                itemCard.classList.remove('item-selected');
                showMessage(`${item.name} removed from cart.`, 'info');
            } else {
                // Item is not in cart, add it
                window.cart.push({ ...item, quantity: 1 });
                itemCard.classList.add('item-selected');
                showMessage(`${item.name} added to cart!`, 'success');
            }
            updateCartDisplay();
        }


        // --- UI RENDERING ---

        function renderShopItems() {
            const container = document.getElementById('itemContainer');
            container.innerHTML = shopItems.map(item => `
                <div id="item-${item.id}" onclick="toggleCartItem(shopItems.find(i => i.id === ${item.id}))"
                    class="item-card bg-gray-900 p-6 rounded-xl hover:bg-gray-800 transition duration-200">
                    <div class="flex items-center space-x-4">
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded-full object-cover border-2 border-pink-400">
                        <div>
                            <h3 class="text-xl font-extrabold text-pink-400">${item.name}</h3>
                            <p class="text-md text-gray-300">$${item.price.toFixed(2)}</p>
                        </div>
                    </div>
                    <p class="mt-4 text-gray-400">${item.desc}</p>
                    <p class="mt-2 text-sm text-pink-300 font-semibold">Click to Add/Remove from Cart!</p>
                </div>
            `).join('');
        }

        // --- BACKGROUND CANVAS ANIMATION ---

        let canvas, ctx, width, height, dots;
        const DOT_COUNT = 100;

        function initCanvas() {
            canvas = document.getElementById('dotCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            dots = [];
            for (let i = 0; i < DOT_COUNT; i++) {
                dots.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2 + 1,
                    color: `rgba(255, 153, 204, ${Math.random() * 0.5 + 0.1})` // Pink
                });
            }
        }

        function resizeCanvas() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Faint trail
            ctx.fillRect(0, 0, width, height);

            dots.forEach(dot => {
                // Update position
                dot.x += dot.vx;
                dot.y += dot.vy;

                // Wrap around edges
                if (dot.x < 0) dot.x = width;
                if (dot.x > width) dot.x = 0;
                if (dot.y < 0) dot.y = height;
                if (dot.y > height) dot.y = 0;

                // Draw dot
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dot.radius, 0, Math.PI * 2);
                ctx.fillStyle = dot.color;
                ctx.fill();
            });

            requestAnimationFrame(draw);
        }

        // --- INITIALIZATION ---

        window.onload = function () {
            // Setup Shop UI
            renderShopItems();
            updateCartDisplay();
            
            // Setup Background
            initCanvas();
            draw();
            
            // NOTE: Firebase setup is handled by the <script type="module"> block
        };

    </script>
</body>

</html>
